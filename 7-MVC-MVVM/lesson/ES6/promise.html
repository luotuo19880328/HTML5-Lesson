<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
	</head>

	<body>
		<script type="text/javascript">
			// 回调地狱
			// 1.股票名称
			$.getJSON('/stock/name', function(res) {
				let { name } = res;
				// 2.股票代码
				$.getJSON('/stock/code', { name }, function(res) {
					let { code } = res;
					// 3.股票价格
					$.getJSON('/stock/price', { code }, function(res) {
						let { price } = res;
						console.log("股票价格：" + price);
					});
				});
			});
			// Promise使用方法,解决了回调函数不断嵌套，改成链式编程
			getJSON('/stock/name')
				.then((res1) => {
					// 捕获成功返回的JSON
					console.log(res1);
					return getJSON('/stock/code');
				})
				.then((res2) => {
					// 捕获第二次返回的结果
					console.log(res2);
					return getJSON('/stock/price');
				})
				.then((res3) => {
					// 捕获第三次返回的结果
					console.log(res3);
				})
		</script>

		<script type="text/javascript">
			// promise实例
			var promise = new Promise(function(resolve, reject) {
				setTimeout(function() {
					var x = Math.random();
					if (x >= 0.5) {
						// 调用内部的函数，状态=>fulfilled
						resolve('成功：' + x);
					} else {
						// 调用内部的函数，状态=>rejected
						reject('失败：' + x);
					}
				}, 500);
			});
			// 捕获结果
			// then 捕获成功
			promise.then(function(value) {
				// 成功
				console.log(value);
			});
			// catch 捕获失败
			promise.catch(function(err) {
				// 失败
				console.log(err);
			})
			// finally 不管成功与失败
		</script>
		<script type="text/javascript">
			// 利用Promise封装ajax的方法,GET、POST
			function getJSON(url) {
				// 生成一个实例
				let promise = new Promise(function(resolve, reject) {
					// 发送ajax
					var ajax = new XMLHttpRequest();
					ajax.open('GET', url, true);
					ajax.send();
					// 监听返回的JSON
					ajax.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							// 成功返回
							let json = JSON.parse(this.responseText);
							resolve(json);
						}
						if (this.status != 200 || this.status != 304) {
							// 失败
							reject(this.status + ':' + this.statusText);
						}
					}
				});
				return promise;
			}
		</script>

		<script type="text/javascript">
			// 自动执行
			(
				function() {
					setTimeout(function() {
						console.log(4);
					}, 0);
					var count = 0;
					new Promise(function(resolve, reject) {
						console.log(1);
						for (let i = 0; i < 2; i++) {
							count += i;
						};
						resolve(console.log(2));
					}).then(function(data) {
						console.log(3);
					});
					console.log(5);
				}
			)();
			// 1 2 5 3 4
		</script>

	</body>

</html>
